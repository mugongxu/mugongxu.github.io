<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>监控前端代码版本迭代实现页面自动刷新 - mugongxu的博客</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/mugongxu"><span>Github</span></a></li><li><a href="https://www.v2ex.com/"><span>V2EX</span></a></li><li><a href="http://m.xuguoqian.com/"><span>酷猫</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="http://callfiles.ueibo.com/hexo-theme-laughing/post_background.jpg"><div class="post-title"><h1 class="title">监控前端代码版本迭代实现页面自动刷新</h1><ul class="meta"><li><i class="icon icon-author"></i>mugongxu</li><li><i class="icon icon-clock"></i>25 Minutes</li><li><i class="icon icon-calendar"></i>2019年11月11日</li></ul></div></div><div class="article-content" style="max-width:800px"><p>背景：当前端版本迭代较为频繁的时候，使用webpack对项目进行打包，虽然我们对js和css文件使用了chunkhash进行了文件缓存控制，但是项目的index.html文件在版本频繁迭代更新时，会存在被浏览器缓存的情况。在发版后，用户不强制刷新页面，浏览器会使用缓存的index.html文件，从而导致向服务器端请求了上个版本chunkhash的js和css文件，最终页面404（上个版本chunkhash的js和css在版本更新时已替换删除了）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output: &#123;</span><br><span class="line">  path: config.build.assetsRoot,</span><br><span class="line">  filename: utils.assetsPath(<span class="string">'js/[name].[chunkhash].js'</span>),</span><br><span class="line">  chunkFilename: utils.assetsPath(<span class="string">'js/[id].[chunkhash].js'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解决思路：</p>
<ol>
<li>服务器端发版，上一个版本的代码不删掉；</li>
<li>在每次打包生产代码时，在static下生产一个version.json的版本信息文件，在前端页面实时请求服务器端的version.json中的版本号和浏览器本地缓存的version.json进行对比，从而监控版本迭代更新，实现页面自动更新，获取新的index.html文件。</li>
</ol>
<p>思路1，缺点是会随着频繁发版，服务器端前端项目文件会越来越多，浪费空间；现在以思路2进行处理：</p>
<ol>
<li>配置环境</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/dev.env.js</span></span><br><span class="line"><span class="meta">'use strict'</span></span><br><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>)</span><br><span class="line"><span class="keyword">const</span> prodEnv = <span class="built_in">require</span>(<span class="string">'./prod.env'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(prodEnv, &#123;</span><br><span class="line">  NODE_ENV: <span class="string">'"development"'</span>,</span><br><span class="line">  VERSION: <span class="string">'""'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// config/prod.env.js</span></span><br><span class="line"><span class="meta">'use strict'</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  NODE_ENV: <span class="string">'"production"'</span>, <span class="comment">// 区分开发/生产环境</span></span><br><span class="line">  VERSION: <span class="string">'"v'</span> + <span class="keyword">new</span> <span class="built_in">Date</span>().getTime() + <span class="string">'"'</span> <span class="comment">// 版本格式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>自定义版本信息生成插件: <a href="https://www.webpackjs.com/contribute/writing-a-plugin/" target="_blank" rel="noopener">如何编写一个插件？</a></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> FStream = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 版本信息生成插件</span></span><br><span class="line"><span class="comment"> * @author guoqian.xu</span></span><br><span class="line"><span class="comment"> * @param options</span></span><br><span class="line"><span class="comment"> * @constructor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">VersionPlugin</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.options = options || &#123;&#125;;</span><br><span class="line">  !<span class="keyword">this</span>.options.versionDirectory &amp;&amp; (<span class="keyword">this</span>.options.versionDirectory = <span class="string">'static'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// apply方法是必须要有的，因为当我们使用一个插件时（new somePlugins(&#123;&#125;)），webpack会去寻找插件的apply方法执行</span></span><br><span class="line">VersionPlugin.prototype.apply = <span class="function"><span class="keyword">function</span> (<span class="params">compiler</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  compiler.plugin(<span class="string">'compile'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> dir_path = <span class="keyword">this</span>.options.context + <span class="string">'/'</span> + self.options.versionDirectory;</span><br><span class="line">    <span class="keyword">var</span> version_file = dir_path + <span class="string">'/version.json'</span>;</span><br><span class="line">    <span class="keyword">var</span> content = <span class="string">'&#123;"version":'</span> + self.options.env.VERSION + <span class="string">'&#125;'</span>;</span><br><span class="line">    FStream.exists(dir_path, <span class="function"><span class="keyword">function</span> (<span class="params">exist</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (exist) &#123;</span><br><span class="line">        writeVersion(self, version_file, content);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      FStream.mkdir(dir_path, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'\n创建目录['</span> + dir_path + <span class="string">']成功'</span>);</span><br><span class="line">        writeVersion(self, version_file, content);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 编译器对'所有任务已经完成'这个事件的监听</span></span><br><span class="line">  compiler.plugin(<span class="string">'done'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">stats</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'应用编译完成！'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> writeVersion = <span class="function">(<span class="params">self, versionFile, content</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'\n当前版本号：'</span> + self.options.env.VERSION);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'开始写入版本信息...'</span>);</span><br><span class="line">  <span class="comment">// 写入文件</span></span><br><span class="line">  FStream.writeFile(versionFile, content, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'版本信息写入成功！'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = VersionPlugin;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>加载插件</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.prod.config.js</span></span><br><span class="line"><span class="comment">// 版本信息生成</span></span><br><span class="line"><span class="keyword">const</span> VersionPlugin = <span class="built_in">require</span>(<span class="string">'./version-plugin'</span>);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> webpackConfig = merge(baseWebpackConfig, &#123;</span><br><span class="line">  ...</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="comment">// 版本信息生成</span></span><br><span class="line">    <span class="keyword">new</span> VersionPlugin(&#123;</span><br><span class="line">      path: config.build.assetsRoot,</span><br><span class="line">      env: env,</span><br><span class="line">      versionDirectory: <span class="string">'static'</span></span><br><span class="line">    &#125;),</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>选择你需要的位置进行监控（路由钩子、特定页面等）</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 版本监控</span></span><br><span class="line"><span class="keyword">async</span> versionCheck() &#123;</span><br><span class="line">  <span class="keyword">if</span> (NODE_ENV === <span class="string">'development'</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="keyword">this</span>.$ajax.get(<span class="string">`../static/version.json`</span>);</span><br><span class="line">  <span class="keyword">if</span> (VERSION !== response.data.version) &#123;</span><br><span class="line">    <span class="keyword">this</span>.$alert(<span class="string">'发现新版本，自动更新中...'</span>, <span class="string">'温馨提示'</span>, &#123;</span><br><span class="line">      confirmButtonText: <span class="string">'我知道了'</span>,</span><br><span class="line">      type: <span class="string">'warning'</span>,</span><br><span class="line">      closeOnClickModal: <span class="literal">false</span>,</span><br><span class="line">      closeOnPressEscape: <span class="literal">false</span>,</span><br><span class="line">      showClose: <span class="literal">false</span>,</span><br><span class="line">      callback: <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">window</span>.location.reload(<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>路由钩子实现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/index.js</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'vue-router'</span>;</span><br><span class="line"><span class="keyword">import</span> routeInterceptor <span class="keyword">from</span> <span class="string">'./hooks'</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">router.beforeEach(routeInterceptor);</span><br><span class="line"></span><br><span class="line"><span class="comment">// hooks/index.js</span></span><br><span class="line"><span class="comment">/* hooks 目录用于配置路由钩子 */</span></span><br><span class="line"><span class="keyword">import</span> routerViewChange <span class="keyword">from</span> <span class="string">'./routerViewChange'</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> allHooks = [</span><br><span class="line">  <span class="comment">/* 放置全部的路由钩子 */</span></span><br><span class="line">  routerViewChange</span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> routeInterceptor = <span class="function">(<span class="params">&#123; path: toPath, query: toQuery, matched &#125;, &#123; path: fromPath &#125;, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 路由拦截</span></span><br><span class="line">  <span class="keyword">if</span> (matched.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 404页面</span></span><br><span class="line">    next(&#123; <span class="attr">path</span>: <span class="string">'/error/404'</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 找到匹配当前路由的钩子</span></span><br><span class="line">    <span class="keyword">const</span> hookMatched = allHooks.filter(<span class="function">(<span class="params">&#123; path: hookPath &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (hookPath <span class="keyword">instanceof</span> <span class="built_in">RegExp</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> routerPathReg = hookPath;</span><br><span class="line">        <span class="keyword">return</span> routerPathReg.test(toPath);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hookPath === toPath;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> hookLen = hookMatched.length;</span><br><span class="line">    <span class="keyword">if</span> (hookLen) &#123;</span><br><span class="line">      <span class="keyword">let</span> hookActived = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// 匹配到路由钩子后, 触发该路由下的全部钩子函数</span></span><br><span class="line">      hookMatched.forEach(<span class="function">(<span class="params">hook <span class="regexp">/* ,  idx */</span></span>) =&gt;</span> &#123;</span><br><span class="line">        hook.action(&#123;</span><br><span class="line">          toPath,</span><br><span class="line">          fromPath,</span><br><span class="line">          toQuery,</span><br><span class="line">          next(params) &#123;</span><br><span class="line">            <span class="comment">// 使用计数器控制 保证全部路由钩子均执行完毕 (包括异步调用 next 函数)后, 才继续路由导航</span></span><br><span class="line">            <span class="keyword">if</span> (hookActived &lt; hookLen - <span class="number">1</span>) &#123;</span><br><span class="line">              hookActived += <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            next(params);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      next();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> routeInterceptor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// hooks/routerViewChange.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; ajax &#125; <span class="keyword">from</span> <span class="string">'@/utils'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routerViewChange = &#123;</span><br><span class="line">  path: <span class="regexp">/\/\w+?\//</span>, <span class="comment">// 匹配所有路由</span></span><br><span class="line">  action: <span class="keyword">async</span>(&#123; toPath, next &#125;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (NODE_ENV === <span class="string">'development'</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> ajax.get(<span class="string">`../static/version.json`</span>);</span><br><span class="line">    <span class="keyword">if</span> (VERSION !== response.data.version) &#123;</span><br><span class="line">      <span class="built_in">window</span>.confirm(<span class="string">'发现新版本，自动更新中...'</span>);</span><br><span class="line">      <span class="built_in">window</span>.location.reload(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> routerViewChange;</span><br></pre></td></tr></table></figure>
</div><div class="article-meta" style="max-width:800px"></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2019/10/11/与微信分享配置相关/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/BoizZ" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://weibo.com/heqibang" title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li><li><a href="https://www.segmentfault.com/u/bon" title="SegmentFault" target="_blank"><i class="icon icon-segmentfault"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2019 mugongxu的博客</p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>