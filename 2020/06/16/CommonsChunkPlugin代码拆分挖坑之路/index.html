<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>CommonsChunkPlugin代码拆分挖坑之路 - mugongxu的博客</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/mugongxu"><span>Github</span></a></li><li><a href="https://www.v2ex.com/"><span>V2EX</span></a></li><li><a href="http://m.xuguoqian.com/"><span>酷猫</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="http://callfiles.ueibo.com/hexo-theme-laughing/post_background.jpg"><div class="post-title"><h1 class="title">CommonsChunkPlugin代码拆分挖坑之路</h1><ul class="meta"><li><i class="icon icon-author"></i>mugongxu</li><li><i class="icon icon-clock"></i>21 Minutes</li><li><i class="icon icon-calendar"></i>2020年6月16日</li></ul></div></div><div class="article-content" style="max-width:800px"><h1 id="CommonsChunkPlugin代码拆分挖坑之路"><a href="#CommonsChunkPlugin代码拆分挖坑之路" class="headerlink" title="CommonsChunkPlugin代码拆分挖坑之路"></a>CommonsChunkPlugin代码拆分挖坑之路</h1><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>vue单文件打包，vendor体积过大，影响页面性能。将vue相关的（vue、vuex、vue-router），element-ui、echarts（echarts、zrender），以单独js文件抽离出来，从而减少vendor体积。同时，抽离不太可能更改的模块，对于项目的版本迭代也有一定的好处（避免不必要的文件hash变化，导致重新请求数据）。</p>
<h2 id="开始挖坑"><a href="#开始挖坑" class="headerlink" title="开始挖坑"></a>开始挖坑</h2><p>vue脚手架默认commonsChunkPlugin配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./build/webpack.prod.conf.js</span></span><br><span class="line"><span class="keyword">const</span> webpackConfig = merge(baseWebpackConfig, &#123;</span><br><span class="line">  ...</span><br><span class="line">  plugins: [</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      name: <span class="string">'vendor'</span>,</span><br><span class="line">      minChunks (<span class="built_in">module</span>) &#123;</span><br><span class="line">        <span class="comment">// any required modules inside node_modules are extracted to vendor</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          <span class="built_in">module</span>.resource &amp;&amp;</span><br><span class="line">          /\.js$/.test(<span class="built_in">module</span>.resource) &amp;&amp;</span><br><span class="line">          <span class="built_in">module</span>.resource.indexOf(</span><br><span class="line">            path.join(__dirname, <span class="string">'../node_modules'</span>)</span><br><span class="line">          ) === <span class="number">0</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      name: <span class="string">'manifest'</span>,</span><br><span class="line">      minChunks: <span class="literal">Infinity</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      name: <span class="string">'app'</span>,</span><br><span class="line">      <span class="keyword">async</span>: <span class="string">'vendor-async'</span>,</span><br><span class="line">      children: <span class="literal">true</span>,</span><br><span class="line">      minChunks: <span class="number">3</span></span><br><span class="line">    &#125;),</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里的默认配置是从单一入口：app（entry chunk），将所有的公共插件抽离到vendor上，与webpack相关的运行环境模块抽离到manifest上。</p>
<p>初步的改造是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从vendor中抽离需要的模块数据</span></span><br><span class="line"><span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">  name: <span class="string">'echarts'</span>,</span><br><span class="line">  chunks: [<span class="string">'vendor'</span>],</span><br><span class="line">  minChunks (<span class="built_in">module</span>) &#123;</span><br><span class="line">    <span class="comment">// any required modules inside node_modules are extracted to vendor</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="built_in">module</span>.resource &amp;&amp;</span><br><span class="line">      /echarts|zrender/.test(<span class="built_in">module</span>.resource)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;),</span><br><span class="line"><span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">  name: <span class="string">'element-ui'</span>,</span><br><span class="line">  chunks: [<span class="string">'vendor'</span>],</span><br><span class="line">  minChunks (<span class="built_in">module</span>) &#123;</span><br><span class="line">    <span class="comment">// any required modules inside node_modules are extracted to vendor</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="built_in">module</span>.resource &amp;&amp;</span><br><span class="line">      /element-ui/.test(<span class="built_in">module</span>.resource)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;),</span><br><span class="line"><span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">  name: <span class="string">'vue'</span>,</span><br><span class="line">  chunks: [<span class="string">'vendor'</span>],</span><br><span class="line">  minChunks (<span class="built_in">module</span>) &#123;</span><br><span class="line">    <span class="comment">// any required modules inside node_modules are extracted to vendor</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="built_in">module</span>.resource &amp;&amp;</span><br><span class="line">      /vue/.test(<span class="built_in">module</span>.resource)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure>
<p>加上了上面的代码后，打包确实把element-ui、echarts、vue给抽离出来了:</p>
<p><img src="./1592357780.png" alt="打包后结果"></p>
<p>以为有所成就了，立即发布到测试环境，万万没想到呀，出错了！</p>
<p><img src="./1592358102.png" alt="webpackJsonp出错了"></p>
<p><img src="./1592359913.png" alt="出错具体位置"></p>
<p>由<code>webpackJsonp</code> is not defined可想而知，是webpack打包后的运行环境出现了问题，<a href="https://webpack.js.org/configuration/output/#outputjsonpfunction" target="_blank" rel="noopener">官网介绍</a></p>
<p>根据CommonsChunkPlugin的配置可知，webpack运行相关的代码都拆分到了<a href="https://webpack.js.org/plugins/commons-chunk-plugin/#combining-implicit-common-vendor-chunks-and-manifest-file" target="_blank" rel="noopener">manifest</a>中，可以猜测：</p>
<ol>
<li>manifest打包出错了</li>
<li>not defined 在平常开发工作中十分常见，运行时webpackJsonp未定义</li>
</ol>
<p>猜想1中，由于只是单一从vendor里拆出正则对应的chunk，几乎不影响webpack运行环境的抽离，很明显出错的概率很小。</p>
<p>大概率是猜想2的问题，查看了一下打包后的<code>index.html</code>文件</p>
<p><img src="./1592359518.png" alt="index.html"></p>
<p>对比一下，我们其他环境（正常环境）的<code>index.html</code></p>
<p><img src="./1592359683.png" alt="正常的index.html"></p>
<p>很明显，对于manifest.js的script调用顺序发生了改变，从而导致了webpackJsonp为not defined，所以我们需要改变chunks写入<code>index.html</code>的顺序</p>
<p>chunks的写入就是<a href="https://www.webpackjs.com/plugins/html-webpack-plugin/" target="_blank" rel="noopener">HtmlWebpackPlugin</a>的工作了</p>
<p>vue脚手架出来，默认配置：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.prod.conf.js</span></span><br><span class="line"><span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// necessary to consistently work with multiple chunks via CommonsChunkPlugin</span></span><br><span class="line">  chunksSortMode: <span class="string">'dependency'</span></span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure></p>
<p>chunksSortMode：允许在插入html之前控制chunks的排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Allows to control how chunks should be sorted before they are included to the HTML. Allowed values are &apos;dependency&apos; | &apos;none&apos; | &apos;auto&apos; | &apos;manual&apos; | &#123;Function&#125;</span><br></pre></td></tr></table></figure>
<p>‘dependency’：按照不同文件的依赖关系来排序，貌似在4.0版本以上看不到这个了<br>‘auto’：默认值<br>‘none’<br>‘manual’：自定义排序</p>
<p>既然一开始 chunksSortMode: ‘dependency’报错，说明上述拆分导致了文件间的依赖关系发生了错乱，这点没搞太懂，望各位大佬赐教一下…</p>
<p>搞不懂依赖关系为啥错乱，那么就手动添加chunks的写入顺序：<br>顺序要注意，app.js依赖于其他插件、库文件，所以必须在<code>最后</code>才加载，否则会产生大量的not defined错误</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.prod.conf.js</span></span><br><span class="line"><span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// necessary to consistently work with multiple chunks via CommonsChunkPlugin</span></span><br><span class="line">  chunksSortMode: <span class="string">'manual'</span>,</span><br><span class="line">  chunks: [<span class="string">'manifest'</span>, <span class="string">'vendor'</span>, <span class="string">'vue'</span>, <span class="string">'element-ui'</span>, <span class="string">'echarts'</span>, <span class="string">'app'</span>]</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure>
<p>打包后的文件妥妥的按照既定的顺序：</p>
<p><img src="./1592378004.png" alt="修改顺序后打包"></p>
<p>然后放到测试环境，就可以正常运行了….</p>
<h3 id="疑惑点"><a href="#疑惑点" class="headerlink" title="疑惑点"></a>疑惑点</h3><p>有点怪异的是：前一天按照上文配置了，放到测试环境时，却出现了如下的错误（<code>这里的图是个类似的错误内容截图</code>，都是manifest.js里出现的’call’ of underfined）</p>
<p><img src="./1592378554.png" alt="奇怪的错误"></p>
<p>所以以为manifest提取的chunks不完整导致的，加了下方的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">  name: <span class="string">'manifest'</span>,</span><br><span class="line">  chunks: [<span class="string">'vendor'</span>, <span class="string">'vue'</span>, <span class="string">'element-ui'</span>, <span class="string">'echarts'</span>, <span class="string">'app'</span>],</span><br><span class="line">  minChunks: <span class="literal">Infinity</span></span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure>
<p>神奇的没问题了QAQ</p>
<p>然后第二天把这代码去掉重新打包，却没有了上面的问题，各位大佬有啥好的见解呢？</p>
<h2 id="简单对比一下splitChunks"><a href="#简单对比一下splitChunks" class="headerlink" title="简单对比一下splitChunks"></a>简单对比一下splitChunks</h2><p>vue-cli3对splitChunks的默认配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// code splitting</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'test'</span>) &#123;</span><br><span class="line">  webpackConfig</span><br><span class="line">    .optimization.splitChunks(&#123;</span><br><span class="line">      cacheGroups: &#123;</span><br><span class="line">        vendors: &#123;</span><br><span class="line">          name: <span class="string">`chunk-vendors`</span>,</span><br><span class="line">          test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">          priority: <span class="number">-10</span>,</span><br><span class="line">          chunks: <span class="string">'initial'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        common: &#123;</span><br><span class="line">          name: <span class="string">`chunk-common`</span>,</span><br><span class="line">          minChunks: <span class="number">2</span>,</span><br><span class="line">          priority: <span class="number">-20</span>,</span><br><span class="line">          chunks: <span class="string">'initial'</span>,</span><br><span class="line">          reuseExistingChunk: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而我们在vue.config.js上实现对element-ui和vue的拆分十分的简单，主要的就是对priority优先级的处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  chainWebpack: <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// code splitting</span></span><br><span class="line">    config.optimization.splitChunks(&#123;</span><br><span class="line">      cacheGroups: &#123;</span><br><span class="line">        vendors: &#123;</span><br><span class="line">          name: <span class="string">`chunk-vendors`</span>,</span><br><span class="line">          test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">          priority: <span class="number">-10</span>,</span><br><span class="line">          chunks: <span class="string">'initial'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        common: &#123;</span><br><span class="line">          name: <span class="string">`chunk-common`</span>,</span><br><span class="line">          minChunks: <span class="number">2</span>,</span><br><span class="line">          priority: <span class="number">-20</span>,</span><br><span class="line">          chunks: <span class="string">'initial'</span>,</span><br><span class="line">          reuseExistingChunk: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 将element-ui单独拆分出来</span></span><br><span class="line">        element: &#123;</span><br><span class="line">          name: <span class="string">`element-ui`</span>,</span><br><span class="line">          test: <span class="regexp">/element-ui/</span>,</span><br><span class="line">          priority: <span class="number">10</span>,</span><br><span class="line">          chunks: <span class="string">'all'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 将vue相关的单独拆分出来</span></span><br><span class="line">        vue: &#123;</span><br><span class="line">          name: <span class="string">`vue`</span>,</span><br><span class="line">          test: <span class="regexp">/vue/</span>,</span><br><span class="line">          priority: <span class="number">20</span>,</span><br><span class="line">          chunks: <span class="string">'all'</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>相比于CommonsChunkPlugin可谓十分的简单。</p>
<p>以上只是一点小小的见解，如有错误，不吝赐教！！！！！</p>
</div><div class="article-meta" style="max-width:800px"></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2020/11/16/CentOS7安装Jenkins/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2020/06/08/前端项目部署/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/BoizZ" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://weibo.com/heqibang" title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li><li><a href="https://www.segmentfault.com/u/bon" title="SegmentFault" target="_blank"><i class="icon icon-segmentfault"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2020 mugongxu的博客</p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>